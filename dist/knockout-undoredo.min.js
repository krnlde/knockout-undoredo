"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_temp,_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_applyDecoratedDescriptor2=_interopRequireDefault(require("@babel/runtime/helpers/applyDecoratedDescriptor")),_coreDecorators=require("core-decorators"),_knockout=_interopRequireDefault(require("knockout")),log=function(){},UndoManager=(_class=_temp=function(){function n(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=r.steps,o=void 0===s?30:s,i=r.throttle,a=void 0===i?300:i;(0,_classCallCheck2.default)(this,n),(0,_defineProperty2.default)(this,"steps",_knockout.default.observable(30)),(0,_defineProperty2.default)(this,"past",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"future",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"throttle",_knockout.default.observable(300)),(0,_defineProperty2.default)(this,"hasUndo",_knockout.default.pureComputed(function(){return Boolean(t.past().length)})),(0,_defineProperty2.default)(this,"hasRedo",_knockout.default.pureComputed(function(){return Boolean(t.future().length)})),(0,_defineProperty2.default)(this,"_changeset",[]),(0,_defineProperty2.default)(this,"recording",_knockout.default.observable()),(0,_defineProperty2.default)(this,"_subscriptions",new WeakMap),(0,_defineProperty2.default)(this,"_subscriptionsCount",0),(0,_defineProperty2.default)(this,"_ignoreChanges",!1),this.steps(o),this.throttle(a),this.startListening(e)}return(0,_createClass2.default)(n,[{key:"startListening",value:function(e){var s=this;if(this.isUndoable(e)){if(this._subscriptions.has(e))return;var o=e,i=o.peek();if(Array.isArray(i)){i=(0,_toConsumableArray2.default)(i);var t=o.subscribe(function(e){var r=0,t=e.reduce(function(e,t){switch(e=(0,_toConsumableArray2.default)(e),t.status){case"added":return s.startListening(t.value),e.splice(t.index+r++,0,t.value),e;case"deleted":return e.splice(t.index+r--,1),s.stopListening(t.value),e;default:return e}},i);s.onChange({observable:o,nextValue:t,previousValue:i}),i=t},null,"arrayChange");this._subscriptions.set(e,t),this._subscriptionsCount++,i.forEach(function(e){return s.startListening(e)})}else{var r=o.subscribe(function(e){s.onChange({observable:o,nextValue:e,previousValue:i}),i=e});this._subscriptions.set(e,r),this._subscriptionsCount++}}else if("object"===(0,_typeof2.default)(e))for(var a=Object.values(e),n=0;n<a.length;n++){var u=a[n];this.startListening(u)}}},{key:"stopListening",value:function(e){if(this.isUndoable(e)){var t=e,r=t.peek();return this._subscriptions.has(t)&&(this._subscriptions.get(t).dispose(),this._subscriptions.delete(t),this._subscriptionsCount--),void(Array.isArray(r)&&this.stopListening(r))}if("object"===(0,_typeof2.default)(e))for(var s=Object.values(e),o=0;o<s.length;o++){var i=s[o];this.stopListening(i)}}},{key:"takeSnapshot",value:function(){clearTimeout(this.recording()),this.past.splice(0,this.past().length-this.steps()),this.future([]),this._changeset=[],this.recording(null)}},{key:"onChange",value:function(e){var t=this,r=e.observable,s=e.nextValue,o=e.previousValue;if(!this._ignoreChanges){this.recording()?clearTimeout(this.recording()):this.past.push(this._changeset);var i={observable:r,nextValue:s,previousValue:o};this._changeset.push(i),this.throttle()?this.recording(setTimeout(function(){return t.takeSnapshot()},this.throttle())):this.takeSnapshot()}}},{key:"destroy",value:function(){this.past([]),this.future([])}},{key:"undo",value:function(){var e=this;if(this.past().length){this.recording()&&(clearTimeout(this.recording()),this.recording(null));var t=this.past.pop();this.future.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.previousValue;if(Array.isArray(r)){var s=(0,_toConsumableArray2.default)(t.peek());r.length>s.length&&r.forEach(function(e){s.includes(e)||t.push(e)}),r.length<s.length&&s.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"redo",value:function(){var e=this;if(this.future().length){this.recording()&&(clearTimeout(this.recording()),this.recording(null));var t=this.future.pop();this.past.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.nextValue;if(Array.isArray(r)){var s=(0,_toConsumableArray2.default)(t.peek());r.length>s.length&&r.forEach(function(e){s.includes(e)||t.push(e)}),r.length<s.length&&s.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"isUndoable",value:function(e){return _knockout.default.isWritableObservable(e)&&_knockout.default.isSubscribable(e)}}]),n}(),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"startListening",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"startListening"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"stopListening",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"stopListening"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"takeSnapshot",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"takeSnapshot"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"destroy",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"destroy"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"undo",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"undo"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"redo",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"redo"),_class.prototype),(0,_applyDecoratedDescriptor2.default)(_class.prototype,"isUndoable",[_coreDecorators.autobind],Object.getOwnPropertyDescriptor(_class.prototype,"isUndoable"),_class.prototype),_class);exports.default=UndoManager;