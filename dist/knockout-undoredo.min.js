"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es7.object.values");var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));require("core-js/modules/es6.weak-set"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.string.iterator"),require("core-js/modules/es6.weak-map");var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_knockout=_interopRequireDefault(require("knockout")),UndoManager=function i(){var a=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.steps,r=void 0===t?30:t,n=e.throttle,o=void 0===n?300:n;(0,_classCallCheck2.default)(this,i),(0,_defineProperty2.default)(this,"steps",_knockout.default.observable(30)),(0,_defineProperty2.default)(this,"past",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"future",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"throttle",_knockout.default.observable(300)),(0,_defineProperty2.default)(this,"hasUndo",_knockout.default.pureComputed(function(){return Boolean(a.past().length)})),(0,_defineProperty2.default)(this,"hasRedo",_knockout.default.pureComputed(function(){return Boolean(a.future().length)})),(0,_defineProperty2.default)(this,"_changeset",[]),(0,_defineProperty2.default)(this,"recording",_knockout.default.observable()),(0,_defineProperty2.default)(this,"_subscriptions",new WeakMap),(0,_defineProperty2.default)(this,"_subscriptionsCount",0),(0,_defineProperty2.default)(this,"_ignoreChanges",!1),(0,_defineProperty2.default)(this,"startListening",function(e){var u=new WeakSet;!function t(e){if(!(e instanceof i||u.has(e)))if(a.isObject(e)&&u.add(e),a.isUndoable(e)){if(a._subscriptions.has(e))return;var n=e,o=n.peek();if(Array.isArray(o)){o=(0,_toConsumableArray2.default)(o);var r=n.subscribe(function(e){var r=0,t=e.reduce(function(e,t){switch(e=(0,_toConsumableArray2.default)(e),t.status){case"added":return a.startListening(t.value),e.splice(t.index+r++,0,t.value),e;case"deleted":return e.splice(t.index+r--,1),a.stopListening(t.value),e;default:return e}},o);a.onChange({observable:n,nextValue:t,previousValue:o}),o=t},null,"arrayChange");a._subscriptions.set(e,r),a._subscriptionsCount++,o.forEach(function(e){return t(e)})}else{var s=n.subscribe(function(e){a.onChange({observable:n,nextValue:e,previousValue:o}),o=e});a._subscriptions.set(e,s),a._subscriptionsCount++,t(o)}}else a.isObject(e)&&Object.values(e).forEach(function(e){return t(e)})}(e)}),(0,_defineProperty2.default)(this,"stopListening",function(e){var o=new WeakSet;!function t(e){if(!o.has(e)){if(a.isObject(e)&&o.add(e),a.isUndoable(e)){var r=e,n=r.peek();return a._subscriptions.has(r)&&(a._subscriptions.get(r).dispose(),a._subscriptions.delete(r),a._subscriptionsCount--),void t(n)}a.isObject(e)&&Object.values(e).forEach(function(e){return t(e)})}}(e)}),(0,_defineProperty2.default)(this,"isObject",function(e){return e&&e instanceof Object&&!(e instanceof Function)}),(0,_defineProperty2.default)(this,"takeSnapshot",function(){clearTimeout(a.recording()),a.past.splice(0,a.past().length-a.steps()),a.future([]),a._changeset=[],a.recording(null)}),(0,_defineProperty2.default)(this,"onChange",function(e){var t=e.observable,r=e.nextValue,n=e.previousValue;if(!a._ignoreChanges){a.recording()?clearTimeout(a.recording()):a.past.push(a._changeset);var o={observable:t,nextValue:r,previousValue:n};a._changeset.push(o),a.throttle()?a.recording(setTimeout(function(){return a.takeSnapshot()},a.throttle())):a.takeSnapshot()}}),(0,_defineProperty2.default)(this,"destroy",function(){a.past([]),a.future([])}),(0,_defineProperty2.default)(this,"undo",function(){if(a.past().length){a.recording()&&(clearTimeout(a.recording()),a.recording(null));var e=a.past.pop();a.future.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var t=e.observable,r=e.previousValue;if(Array.isArray(r)){var n=(0,_toConsumableArray2.default)(t.peek());r.length>n.length&&r.forEach(function(e){n.includes(e)||t.push(e)}),r.length<n.length&&n.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return a._ignoreChanges=!1})}}),(0,_defineProperty2.default)(this,"redo",function(){if(a.future().length){a.recording()&&(clearTimeout(a.recording()),a.recording(null));var e=a.future.pop();a.past.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var t=e.observable,r=e.nextValue;if(Array.isArray(r)){var n=(0,_toConsumableArray2.default)(t.peek());r.length>n.length&&r.forEach(function(e){n.includes(e)||t.push(e)}),r.length<n.length&&n.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return a._ignoreChanges=!1})}}),(0,_defineProperty2.default)(this,"isUndoable",function(e){return _knockout.default.isWritableObservable(e)&&_knockout.default.isSubscribable(e)}),this.steps(r),this.throttle(o)};exports.default=UndoManager;