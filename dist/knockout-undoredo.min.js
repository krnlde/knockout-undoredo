"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es6.object.define-property"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es7.object.values"),require("core-js/modules/es6.array.for-each"),require("core-js/modules/es6.array.reduce");var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));require("core-js/modules/es6.array.is-array"),require("core-js/modules/es6.weak-set"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.string.iterator"),require("core-js/modules/es6.weak-map");var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_knockout=_interopRequireDefault(require("knockout")),UndoManager=function i(){var a=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=e.steps,t=void 0===r?30:r,n=e.throttle,s=void 0===n?300:n;(0,_classCallCheck2.default)(this,i),(0,_defineProperty2.default)(this,"steps",_knockout.default.observable(30)),(0,_defineProperty2.default)(this,"past",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"future",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"throttle",_knockout.default.observable(300)),(0,_defineProperty2.default)(this,"hasUndo",_knockout.default.pureComputed(function(){return Boolean(a.past().length)})),(0,_defineProperty2.default)(this,"hasRedo",_knockout.default.pureComputed(function(){return Boolean(a.future().length)})),(0,_defineProperty2.default)(this,"_changeset",[]),(0,_defineProperty2.default)(this,"recording",_knockout.default.observable()),(0,_defineProperty2.default)(this,"_subscriptions",new WeakMap),(0,_defineProperty2.default)(this,"_subscriptionsCount",0),(0,_defineProperty2.default)(this,"_ignoreChanges",!1),(0,_defineProperty2.default)(this,"startListening",function(e){var u=new WeakSet;!function r(e){if(!(e instanceof i||u.has(e)))if(a.isObject(e)&&u.add(e),a.isUndoable(e)){if(a._subscriptions.has(e))return;var n=e,s=n.peek();if(Array.isArray(s)){s=(0,_toConsumableArray2.default)(s);var t=n.subscribe(function(e){var t=0,r=e.reduce(function(e,r){switch(e=(0,_toConsumableArray2.default)(e),r.status){case"added":return a.startListening(r.value),e.splice(r.index+t++,0,r.value),e;case"deleted":return e.splice(r.index+t--,1),a.stopListening(r.value),e;default:return e}},s);a.onChange({observable:n,nextValue:r,previousValue:s}),s=r},null,"arrayChange");a._subscriptions.set(e,t),a._subscriptionsCount++,s.forEach(function(e){return r(e)})}else{var o=n.subscribe(function(e){a.onChange({observable:n,nextValue:e,previousValue:s}),s=e});a._subscriptions.set(e,o),a._subscriptionsCount++,r(s)}}else a.isObject(e)&&Object.values(e).forEach(function(e){return r(e)})}(e)}),(0,_defineProperty2.default)(this,"stopListening",function(e){var s=new WeakSet;!function r(e){if(!s.has(e)){if(a.isObject(e)&&s.add(e),a.isUndoable(e)){var t=e,n=t.peek();return a._subscriptions.has(t)&&(a._subscriptions.get(t).dispose(),a._subscriptions.delete(t),a._subscriptionsCount--),void r(n)}a.isObject(e)&&Object.values(e).forEach(function(e){return r(e)})}}(e)}),(0,_defineProperty2.default)(this,"isObject",function(e){return e&&e instanceof Object&&!(e instanceof Function)}),(0,_defineProperty2.default)(this,"takeSnapshot",function(){clearTimeout(a.recording()),a.past.splice(0,a.past().length-a.steps()),a.future([]),a._changeset=[],a.recording(null)}),(0,_defineProperty2.default)(this,"onChange",function(e){var r=e.observable,t=e.nextValue,n=e.previousValue;if(!a._ignoreChanges){a.recording()?clearTimeout(a.recording()):a.past.push(a._changeset);var s={observable:r,nextValue:t,previousValue:n};a._changeset.push(s),a.throttle()?a.recording(setTimeout(function(){return a.takeSnapshot()},a.throttle())):a.takeSnapshot()}}),(0,_defineProperty2.default)(this,"destroy",function(){a.past([]),a.future([])}),(0,_defineProperty2.default)(this,"undo",function(){if(a.past().length){a.recording()&&(clearTimeout(a.recording()),a.recording(null));var e=a.past.pop();a.future.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var r=e.observable,t=e.previousValue;if(Array.isArray(t)){var n=(0,_toConsumableArray2.default)(r.peek());t.length>n.length&&t.forEach(function(e){n.includes(e)||r.push(e)}),t.length<n.length&&n.forEach(function(e){t.includes(e)||r.remove(e)})}else r(t)}),setTimeout(function(){return a._ignoreChanges=!1})}}),(0,_defineProperty2.default)(this,"redo",function(){if(a.future().length){a.recording()&&(clearTimeout(a.recording()),a.recording(null));var e=a.future.pop();a.past.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var r=e.observable,t=e.nextValue;if(Array.isArray(t)){var n=(0,_toConsumableArray2.default)(r.peek());t.length>n.length&&t.forEach(function(e){n.includes(e)||r.push(e)}),t.length<n.length&&n.forEach(function(e){t.includes(e)||r.remove(e)})}else r(t)}),setTimeout(function(){return a._ignoreChanges=!1})}}),(0,_defineProperty2.default)(this,"isUndoable",function(e){return _knockout.default.isWritableObservable(e)&&_knockout.default.isSubscribable(e)}),this.steps(t),this.throttle(s)};exports.default=UndoManager;