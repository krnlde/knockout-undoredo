"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _desc,_value,_class,_getOwnPropertyDescriptor=require("babel-runtime/core-js/object/get-own-property-descriptor"),_getOwnPropertyDescriptor2=_interopRequireDefault(_getOwnPropertyDescriptor),_values=require("babel-runtime/core-js/object/values"),_values2=_interopRequireDefault(_values),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_weakMap=require("babel-runtime/core-js/weak-map"),_weakMap2=_interopRequireDefault(_weakMap),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_coreDecorators=require("core-decorators"),_knockout=require("knockout"),_knockout2=_interopRequireDefault(_knockout);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _applyDecoratedDescriptor(r,o,e,t,s){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(r,o,e)||e},a),s&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(s):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(r,o,a),a=null),a}var log=function(){},UndoManager=(_applyDecoratedDescriptor((_class=function(){function n(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},o=r.steps,s=void 0===o?30:o,a=r.throttle,i=void 0===a?300:a;(0,_classCallCheck3.default)(this,n),this.steps=_knockout2.default.observable(30),this.past=_knockout2.default.observableArray([]),this.future=_knockout2.default.observableArray([]),this.throttle=_knockout2.default.observable(300),this.hasUndo=_knockout2.default.pureComputed(function(){return Boolean(t.past().length)}),this.hasRedo=_knockout2.default.pureComputed(function(){return Boolean(t.future().length)}),this._changeset=[],this.recording=_knockout2.default.observable(),this._subscriptions=new _weakMap2.default,this._subscriptionsCount=0,this._ignoreChanges=!1,this.steps(s),this.throttle(i),this.startListening(e)}return(0,_createClass3.default)(n,[{key:"startListening",value:function(e){var o=this;if(this.isUndoable(e)){if(this._subscriptions.has(e))return;var s=e,a=s.peek();if(Array.isArray(a)){a=[].concat((0,_toConsumableArray3.default)(a));var t=s.subscribe(function(e){var r=0,t=e.reduce(function(e,t){switch(e=[].concat((0,_toConsumableArray3.default)(e)),t.status){case"added":return o.startListening(t.value),e.splice(t.index+r++,0,t.value),e;case"deleted":return e.splice(t.index+r--,1),o.stopListening(t.value),e;default:return e}},a);o.onChange({observable:s,nextValue:t,previousValue:a}),a=t},null,"arrayChange");this._subscriptions.set(e,t),this._subscriptionsCount++,a.forEach(function(e){return o.startListening(e)})}else{var r=s.subscribe(function(e){o.onChange({observable:s,nextValue:e,previousValue:a}),a=e});this._subscriptions.set(e,r),this._subscriptionsCount++}}else if("object"===(void 0===e?"undefined":(0,_typeof3.default)(e))){var i=!0,n=!1,u=void 0;try{for(var l,c=(0,_getIterator3.default)((0,_values2.default)(e));!(i=(l=c.next()).done);i=!0){var p=l.value;this.startListening(p)}}catch(e){n=!0,u=e}finally{try{!i&&c.return&&c.return()}finally{if(n)throw u}}}}},{key:"stopListening",value:function(e){if(this.isUndoable(e)){var t=e,r=t.peek();return this._subscriptions.has(t)&&(this._subscriptions.get(t).dispose(),this._subscriptions.delete(t),this._subscriptionsCount--),void(Array.isArray(r)&&this.stopListening(r))}if("object"===(void 0===e?"undefined":(0,_typeof3.default)(e))){var o=!0,s=!1,a=void 0;try{for(var i,n=(0,_getIterator3.default)((0,_values2.default)(e));!(o=(i=n.next()).done);o=!0){var u=i.value;this.stopListening(u)}}catch(e){s=!0,a=e}finally{try{!o&&n.return&&n.return()}finally{if(s)throw a}}}}},{key:"takeSnapshot",value:function(){clearTimeout(this.recording()),this.past.splice(0,this.past().length-this.steps()),this.future([]),this._changeset=[],this.recording(null)}},{key:"onChange",value:function(e){var t=this,r=e.observable,o=e.nextValue,s=e.previousValue;if(!this._ignoreChanges){this.recording()?clearTimeout(this.recording()):this.past.push(this._changeset);var a={observable:r,nextValue:o,previousValue:s};this._changeset.push(a),this.throttle()?this.recording(setTimeout(function(){return t.takeSnapshot()},this.throttle())):this.takeSnapshot()}}},{key:"destroy",value:function(){this.past([]),this.future([])}},{key:"undo",value:function(){var e=this;if(this.past().length){this.recording()&&(clearTimeout(this.recording()),this.recording(null));var t=this.past.pop();this.future.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.previousValue;if(Array.isArray(r)){var o=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>o.length&&r.forEach(function(e){o.includes(e)||t.push(e)}),r.length<o.length&&o.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"redo",value:function(){var e=this;if(this.future().length){this.recording()&&(clearTimeout(this.recording()),this.recording(null));var t=this.future.pop();this.past.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.nextValue;if(Array.isArray(r)){var o=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>o.length&&r.forEach(function(e){o.includes(e)||t.push(e)}),r.length<o.length&&o.forEach(function(e){r.includes(e)||t.remove(e)})}else t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"isUndoable",value:function(e){return _knockout2.default.isWritableObservable(e)&&_knockout2.default.isSubscribable(e)}}]),n}()).prototype,"startListening",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"startListening"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"stopListening",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"stopListening"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"takeSnapshot",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"takeSnapshot"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"destroy",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"destroy"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"undo",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"undo"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"redo",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"redo"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isUndoable",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"isUndoable"),_class.prototype),_class);exports.default=UndoManager;