"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_entries=require("babel-runtime/core-js/object/entries"),_entries2=_interopRequireDefault(_entries),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_knockout=require("knockout"),_knockout2=_interopRequireDefault(_knockout),UndoManager=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=r.steps,a=void 0===i?30:i,u=r.throttle,n=void 0===u?300:u;(0,_classCallCheck3.default)(this,e),this.past=[],this.future=[],this.throttle=300,this.undoCollection=[],this._subscriptions=[],this._batchTimeout=null,this._ignoreChanges=!1,this.MAX_UNDO_STEPS=a,this.throttle=n,this.listen(t)}return(0,_createClass3.default)(e,[{key:"listen",value:function(e){var t=this;if(_knockout2.default.isWritableObservable(e)&&!_knockout2.default.isComputed(e)&&_knockout2.default.isSubscribable(e)){var r=function(){var r=e,i=r.peek();if(Array.isArray(i)){i=[].concat((0,_toConsumableArray3.default)(i)),t.listen(i);var a=r.subscribe(function(e){var a=void 0;e.forEach(function(e){switch(e.status){case"added":a=i.splice(e.index,0,e.value),t.listen(e.value);break;case"deleted":a=i.splice(e.index,1),t.cancelListen(e.value)}}),t.change({observable:r,nextValue:a,previousValue:i}),i=a},null,"arrayChange");t._subscriptions.push(a)}else{var u=r.subscribe(function(e){t.change({observable:r,nextValue:e,previousValue:i}),i=e});t._subscriptions.push(u)}return{v:void 0}}();if("object"===("undefined"==typeof r?"undefined":(0,_typeof3.default)(r)))return r.v}if("object"===("undefined"==typeof e?"undefined":(0,_typeof3.default)(e))){var i=(0,_entries2.default)(e);if(i.length){var a=!0,u=!1,n=void 0;try{for(var s,o=(0,_getIterator3.default)(i);!(a=(s=o.next()).done);a=!0){var l=(0,_slicedToArray3.default)(s.value,2),c=(l[0],l[1]);this.listen(c)}}catch(e){u=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(u)throw n}}return}}}},{key:"cancelListen",value:function(e){var t=this;if(_knockout2.default.isWritableObservable(e)&&!_knockout2.default.isComputed(e)&&_knockout2.default.isSubscribable(e)){var r=function(){var r=e,i=r.peek();return t._subscriptions=t._subscriptions.reduce(function(e,t){return t._target===r?t.dispose():e.push(t),e},[]),Array.isArray(i)&&t.cancelListen(i),{v:void 0}}();if("object"===("undefined"==typeof r?"undefined":(0,_typeof3.default)(r)))return r.v}if("object"===("undefined"==typeof e?"undefined":(0,_typeof3.default)(e))){var i=(0,_entries2.default)(e);if(i.length){console.log("is enumerable");var a=!0,u=!1,n=void 0;try{for(var s,o=(0,_getIterator3.default)(i);!(a=(s=o.next()).done);a=!0){var l=(0,_slicedToArray3.default)(s.value,2),c=(l[0],l[1]);this.cancelListen(c)}}catch(e){u=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(u)throw n}}return}}}},{key:"change",value:function(e){var t=this,r=e.observable,i=e.nextValue,a=e.previousValue;if(!this._ignoreChanges){this._batchTimeout?clearTimeout(this._batchTimeout):this.past.push(this.undoCollection);var u={observable:r,nextValue:i,previousValue:a};this.undoCollection.push(u);var n=function(){t.past=t.past.slice(-t.MAX_UNDO_STEPS),t.future=[],t.undoCollection=[],t._batchTimeout=null};this.throttle?this._batchTimeout=setTimeout(n,this.throttle):n()}}},{key:"destroy",value:function(){this.past=[],this.future=[],this._subscriptions.forEach(function(e){return e.dispose()}),this._subscriptions=[]}},{key:"undo",value:function(){var e=this;if(this.past.length){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null);var t=this.past.pop();this.future.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.previousValue;Array.isArray(r)?!function(){var e=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>e.length&&r.forEach(function(r){e.includes(r)||t.push(r)}),r.length<e.length&&e.forEach(function(e){r.includes(e)||t.remove(e)})}():t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"redo",value:function(){var e=this;if(this.future.length){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null);var t=this.future.pop();this.past.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.nextValue;Array.isArray(r)?!function(){var e=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>e.length&&r.forEach(function(r){e.includes(r)||t.push(r)}),r.length<e.length&&e.forEach(function(e){r.includes(e)||t.remove(e)})}():t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}}]),e}();exports.default=UndoManager;