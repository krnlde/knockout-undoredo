"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _applyDecoratedDescriptor(e,t,r,o,s){var i={};return Object.keys(o).forEach(function(e){i[e]=o[e]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce(function(r,o){return o(e,t,r)||r},i),s&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(s):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _getOwnPropertyDescriptor=require("babel-runtime/core-js/object/get-own-property-descriptor"),_getOwnPropertyDescriptor2=_interopRequireDefault(_getOwnPropertyDescriptor),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_values=require("babel-runtime/core-js/object/values"),_values2=_interopRequireDefault(_values),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_weakMap=require("babel-runtime/core-js/weak-map"),_weakMap2=_interopRequireDefault(_weakMap),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_desc,_value,_class,_coreDecorators=require("core-decorators"),_knockout=require("knockout"),_knockout2=_interopRequireDefault(_knockout),log=function(){},UndoManager=(_class=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=r.steps,s=void 0===o?30:o,i=r.throttle,a=void 0===i?300:i;(0,_classCallCheck3.default)(this,e),this.past=[],this.future=[],this.throttle=300,this.changeset=[],this._subscriptions=new _weakMap2.default,this._subscriptionsCount=0,this.recording=null,this._ignoreChanges=!1,this.steps=s,this.throttle=a,this.startListening(t)}return(0,_createClass3.default)(e,[{key:"startListening",value:function(e){var t=this;if(this.isUndoable(e)){var r=function(){if(t._subscriptions.has(e))return{v:void 0};var r=e,o=r.peek();if(Array.isArray(o)){o=[].concat((0,_toConsumableArray3.default)(o));var s=r.subscribe(function(e){var s=0,i=e.reduce(function(e,r){switch(e=[].concat((0,_toConsumableArray3.default)(e)),r.status){case"added":return t.startListening(r.value),e.splice(r.index+s++,0,r.value),e;case"deleted":return e.splice(r.index+s--,1),t.stopListening(r.value),e;default:return e}},o);t.onChange({observable:r,nextValue:i,previousValue:o}),o=i},null,"arrayChange");t._subscriptions.set(e,s),t._subscriptionsCount++,o.forEach(function(e){return t.startListening(e)})}else{var i=r.subscribe(function(e){t.onChange({observable:r,nextValue:e,previousValue:o}),o=e});t._subscriptions.set(e,i),t._subscriptionsCount++}}();if("object"===("undefined"==typeof r?"undefined":(0,_typeof3.default)(r)))return r.v}else if("object"===("undefined"==typeof e?"undefined":(0,_typeof3.default)(e))){var o=(0,_values2.default)(e);if(o.length){var s=!0,i=!1,a=void 0;try{for(var n,u=(0,_getIterator3.default)(o);!(s=(n=u.next()).done);s=!0){var l=n.value;this.startListening(l)}}catch(e){i=!0,a=e}finally{try{!s&&u.return&&u.return()}finally{if(i)throw a}}}}}},{key:"stopListening",value:function(e){if(this.isUndoable(e)){var t=e,r=t.peek();return this._subscriptions.has(t)&&(this._subscriptions.get(t).dispose(),this._subscriptions.delete(t),this._subscriptionsCount--),void(Array.isArray(r)&&this.stopListening(r))}if("object"===("undefined"==typeof e?"undefined":(0,_typeof3.default)(e))){var o=(0,_values2.default)(e);if(o.length){var s=!0,i=!1,a=void 0;try{for(var n,u=(0,_getIterator3.default)(o);!(s=(n=u.next()).done);s=!0){var l=n.value;this.stopListening(l)}}catch(e){i=!0,a=e}finally{try{!s&&u.return&&u.return()}finally{if(i)throw a}}return}}}},{key:"takeSnapshot",value:function(){clearTimeout(this.recording);this.past.splice(0,this.past.length-this.steps);this.future=[],this.changeset=[],this.recording=null}},{key:"onChange",value:function(e){var t=this,r=e.observable,o=e.nextValue,s=e.previousValue;if(!this._ignoreChanges){this.recording?clearTimeout(this.recording):this.past.push(this.changeset);var i={observable:r,nextValue:o,previousValue:s};this.changeset.push(i),this.throttle?this.recording=setTimeout(function(){return t.takeSnapshot()},this.throttle):this.takeSnapshot()}}},{key:"destroy",value:function(){this.past=[],this.future=[]}},{key:"undo",value:function(){var e=this;if(this.past.length){this.recording&&(clearTimeout(this.recording),this.recording=null);var t=this.past.pop();this.future.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.previousValue;Array.isArray(r)?!function(){var e=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>e.length&&r.forEach(function(r){e.includes(r)||t.push(r)}),r.length<e.length&&e.forEach(function(e){r.includes(e)||t.remove(e)})}():t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"redo",value:function(){var e=this;if(this.future.length){this.recording&&(clearTimeout(this.recording),this.recording=null);var t=this.future.pop();this.past.push(t),this._ignoreChanges=!0,t.reverse().forEach(function(e){var t=e.observable,r=e.nextValue;Array.isArray(r)?!function(){var e=[].concat((0,_toConsumableArray3.default)(t.peek()));r.length>e.length&&r.forEach(function(r){e.includes(r)||t.push(r)}),r.length<e.length&&e.forEach(function(e){r.includes(e)||t.remove(e)})}():t(r)}),setTimeout(function(){return e._ignoreChanges=!1})}}},{key:"isUndoable",value:function(e){return _knockout2.default.isWritableObservable(e)&&!_knockout2.default.isComputed(e)&&_knockout2.default.isSubscribable(e)}}]),e}(),_applyDecoratedDescriptor(_class.prototype,"startListening",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"startListening"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"stopListening",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"stopListening"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"takeSnapshot",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"takeSnapshot"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"destroy",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"destroy"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"undo",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"undo"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"redo",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"redo"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isUndoable",[_coreDecorators.autobind],(0,_getOwnPropertyDescriptor2.default)(_class.prototype,"isUndoable"),_class.prototype),_class);exports.default=UndoManager;