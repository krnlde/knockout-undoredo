"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es7.object.values");var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));require("core-js/modules/es6.weak-set"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.array.iterator"),require("core-js/modules/es6.object.to-string"),require("core-js/modules/es6.string.iterator"),require("core-js/modules/es6.weak-map");var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_knockout=_interopRequireDefault(require("knockout")),UndoManager=function i(){var a=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.steps,r=void 0===t?30:t,n=e.throttle,o=void 0===n?300:n;(0,_classCallCheck2.default)(this,i),(0,_defineProperty2.default)(this,"steps",_knockout.default.observable(30)),(0,_defineProperty2.default)(this,"past",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"future",_knockout.default.observableArray([])),(0,_defineProperty2.default)(this,"throttle",_knockout.default.observable(300)),(0,_defineProperty2.default)(this,"hasUndo",_knockout.default.pureComputed(function(){return Boolean(a.past().length)})),(0,_defineProperty2.default)(this,"hasRedo",_knockout.default.pureComputed(function(){return Boolean(a.future().length)})),(0,_defineProperty2.default)(this,"_changeset",[]),(0,_defineProperty2.default)(this,"recording",_knockout.default.observable()),(0,_defineProperty2.default)(this,"_subscriptions",new WeakMap),(0,_defineProperty2.default)(this,"_subscriptionsCount",0),(0,_defineProperty2.default)(this,"_ignoreChanges",!1),(0,_defineProperty2.default)(this,"startListening",function(e){var u=new WeakSet;!function e(t){if(!(t instanceof i||u.has(t)))if(a.isObject(t)&&u.add(t),a.isUndoable(t)){if(a._subscriptions.has(t))return;var r,n,o=t,s=o.peek();Array.isArray(s)?(s=(0,_toConsumableArray2.default)(s),r=o.subscribe(function(e){var r=0,t=e.reduce(function(e,t){switch(e=(0,_toConsumableArray2.default)(e),t.status){case"added":return a.startListening(t.value),e.splice(t.index+r++,0,t.value),e;case"deleted":return e.splice(t.index+r--,1),a.stopListening(t.value),e;default:return e}},s);a.onChange({observable:o,nextValue:t,previousValue:s}),s=t},null,"arrayChange"),a._subscriptions.set(t,r),a._subscriptionsCount++,s.forEach(e)):(n=o.subscribe(function(e){a.onChange({observable:o,nextValue:e,previousValue:s}),s=e}),a._subscriptions.set(t,n),a._subscriptionsCount++,e(s))}else a.isObject(t)&&Object.values(t).forEach(e)}(e)}),(0,_defineProperty2.default)(this,"stopListening",function(e){var o=new WeakSet;!function e(t){if(!o.has(t)){if(a.isObject(t)&&o.add(t),a.isUndoable(t)){var r=t,n=r.peek();return a._subscriptions.has(r)&&(a._subscriptions.get(r).dispose(),a._subscriptions.delete(r),a._subscriptionsCount--),void e(n)}a.isObject(t)&&Object.values(t).forEach(e)}}(e)}),(0,_defineProperty2.default)(this,"isObject",function(e){return e&&e instanceof Object&&!(e instanceof Function)}),(0,_defineProperty2.default)(this,"takeSnapshot",function(){clearTimeout(a.recording()),a.past.splice(0,a.past().length-a.steps()),a.future([]),a._changeset=[],a.recording(null)}),(0,_defineProperty2.default)(this,"onChange",function(e){var t,r=e.observable,n=e.nextValue,o=e.previousValue;a._ignoreChanges||(a.recording()?clearTimeout(a.recording()):a.past.push(a._changeset),t={observable:r,nextValue:n,previousValue:o},a._changeset.push(t),a.throttle()?a.recording(setTimeout(function(){return a.takeSnapshot()},a.throttle())):a.takeSnapshot())}),(0,_defineProperty2.default)(this,"destroy",function(){a.past([]),a.future([])}),(0,_defineProperty2.default)(this,"undo",function(){var e;a.past().length&&(a.recording()&&(clearTimeout(a.recording()),a.recording(null)),e=a.past.pop(),a.future.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var t,r=e.observable,n=e.previousValue;Array.isArray(n)?(t=(0,_toConsumableArray2.default)(r.peek()),n.length>t.length&&n.forEach(function(e){t.includes(e)||r.push(e)}),n.length<t.length&&t.forEach(function(e){n.includes(e)||r.remove(e)})):r(n)}),setTimeout(function(){return a._ignoreChanges=!1}))}),(0,_defineProperty2.default)(this,"redo",function(){var e;a.future().length&&(a.recording()&&(clearTimeout(a.recording()),a.recording(null)),e=a.future.pop(),a.past.push(e),a._ignoreChanges=!0,e.reverse().forEach(function(e){var t,r=e.observable,n=e.nextValue;Array.isArray(n)?(t=(0,_toConsumableArray2.default)(r.peek()),n.length>t.length&&n.forEach(function(e){t.includes(e)||r.push(e)}),n.length<t.length&&t.forEach(function(e){n.includes(e)||r.remove(e)})):r(n)}),setTimeout(function(){return a._ignoreChanges=!1}))}),(0,_defineProperty2.default)(this,"isUndoable",function(e){return _knockout.default.isWritableObservable(e)&&_knockout.default.isSubscribable(e)}),this.steps(r),this.throttle(o)};exports.default=UndoManager;